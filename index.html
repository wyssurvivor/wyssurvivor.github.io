<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.4.5.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="I&apos;m concerned with questions, not simply of immutable truth, but of practice and expedience.">
<meta property="og:type" content="website">
<meta property="og:title" content="Ryan Wang">
<meta property="og:url" content="http://wyssurvivor.github.io/index.html">
<meta property="og:site_name" content="Ryan Wang">
<meta property="og:description" content="I&apos;m concerned with questions, not simply of immutable truth, but of practice and expedience.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ryan Wang">
<meta name="twitter:description" content="I&apos;m concerned with questions, not simply of immutable truth, but of practice and expedience.">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> Ryan Wang </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Ryan Wang</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Standing on Shoulders of Giants</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/30/20160729-offer006/" itemprop="url">
                  20160729-offer006
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-30T15:55:51+08:00" content="2016-07-30">
              2016-07-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/algorithm/" itemprop="url" rel="index">
                    <span itemprop="name">algorithm</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="剑指offer">剑指offer</h2><p>最近无聊，想把丢弃了很久的算法再捡起来，随便找了个网站，发现上面有剑指offer的题，就做了一些。</p>
<p>题目：把一个数组最开始的若干个元素搬到数组的末尾，我们称之为数组的旋转。<br>输入一个递增排序的数组的一个旋转，输出旋转数组的最小元素。<br>例如数组{3,4,5,1,2}为{1,2,3,4,5}的一个旋转，该数组的最小值为1。<br>NOTE：给出的所有元素都大于0，若数组大小为0，请返回0。</p>
<p>我的思路：我的思路很简单，找到中位数，判断中位数是在哪个部分，然后缩小范围，到相应的范围去查找。代码如下：</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">minNumberInRotateArray</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; rotateArray)</span></span>{
<span class="keyword">if</span>(rotateArray.size()==<span class="number">1</span>){
    <span class="keyword">return</span> rotateArray[<span class="number">0</span>];
}
<span class="keyword">if</span>(rotateArray.size()==<span class="number">2</span>){
    <span class="keyword">return</span> rotateArray[<span class="number">0</span>]&gt;rotateArray[<span class="number">1</span>]?rotateArray[<span class="number">1</span>]:rotateArray[<span class="number">0</span>];
}
<span class="keyword">int</span> left=<span class="number">0</span>;
<span class="keyword">int</span> right=rotateArray.size()-<span class="number">1</span>;
<span class="keyword">int</span> mid=(left+right)/<span class="number">2</span>;
<span class="keyword">if</span>(rotateArray[left]&gt;rotateArray[mid]){
    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; leftVec(rotateArray.begin(),rotateArray.begin()+mid+<span class="number">1</span>);
    <span class="keyword">return</span> minNumberInRotateArray(leftVec);
}<span class="keyword">else</span> <span class="keyword">if</span>(rotateArray[mid]&gt;rotateArray[right]){
    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; rightVec(rotateArray.begin()+mid,rotateArray.end());
    <span class="keyword">return</span> minNumberInRotateArray(rightVec);
}<span class="keyword">else</span>{
    <span class="keyword">return</span> rotateArray[mid];
}

}
</code></pre><p>这一题《剑指offer》上的思路是这样的，也是二分法查找，然而是缩小两边两个指针的位置来确定最终的那个数的位置在哪。思路上应该是比我的思路要简单，我的思路在到范围缩小到只有两个数的时候，处理的比较机械，不能把它归到一个统一的思路下，不够优美。而且，我用的是递归的方法，算法跑起来应该会相对慢一些，启示不用递归也能做，就是懒，用了递归。</p>
<pre><code><span class="function"><span class="keyword">int</span> <span class="title">minNumberInRotateArray2</span><span class="params">(<span class="keyword">int</span> *numbers,<span class="keyword">int</span> length)</span></span>{
<span class="keyword">if</span>(numbers==<span class="literal">NULL</span>||length&lt;=<span class="number">0</span>){
    <span class="keyword">throw</span> <span class="keyword">new</span> exception(<span class="string">"Invalid parametes"</span>);
}
<span class="keyword">int</span> index1=<span class="number">0</span>;
<span class="keyword">int</span> index2=length-<span class="number">1</span>;
<span class="keyword">int</span> indexMid=index1;
<span class="keyword">while</span> (numbers[index1]&gt;=numbers[index2]) {
    <span class="keyword">if</span>(index2-index1==<span class="number">1</span>){
        indexMid=index2;
        <span class="keyword">break</span>;
    }
    indexMid=(index1+index2)/<span class="number">2</span>;
    <span class="keyword">if</span>(numbers[indexMid]&gt;=numbers[index1]){
        index1=indexMid;
    }<span class="keyword">else</span> <span class="keyword">if</span>(numbers[indexMid]&lt;=numbers[index2]){
        index2=indexMid;
    }
}
<span class="keyword">return</span> numbers[indexMid];
}
</code></pre>
            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/17/20160717-a-successful-git-branching-model/" itemprop="url">
                  20160717-a-successful-git-branching-model
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-17T13:48:48+08:00" content="2016-07-17">
              2016-07-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="A_successful_git_branching_model">A successful git branching model</h2><p>最近组里刚刚从svn迁移到了git，本以为自己对于git已经有足够的了解了，没想到真正与团队协作开发的时候还是碰到了一些问题，于是还是上网查了一些资料，继续学习。本文实际上是一篇<a href="http://nvie.com/posts/a-successful-git-branching-model/#creating-a-feature-branch" target="_blank" rel="external">A successful git branching model</a>的学习笔记。</p>
<p>不是说一定要完全按照这篇文章作者所描述的那样使用git，只是这篇文章是提供了一套挺完备的开发流程，能够引起我对于自己日常使用git的一些思考。根据这篇文章的介绍的branching经验方法，结合自己的实际情况，应该能够总结出一套更好的也是更适合自己的开发流程。</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/git-model@2x.png" alt="branching pic"></p>
<p>上图基本上就是这个branching model的一个总览图，其中的思想基本上都在里面了。下面详细说明一下。</p>
<h3 id="main_branches">main branches</h3><p>在远程仓库中，有两条分支是始终存在的</p>
<ul>
<li>origin/master</li>
<li>origin/develop</li>
</ul>
<p>origin/master分支始终处于可上线状态或者已上线状态。origin／develop分支包含了开发者最新的修改。如果develop分支的代码都没有问题了，就可以合并到master分支了，真正合并的时候没这么简单，下面再说。</p>
<h3 id="supporting_branches">supporting branches</h3><p>为了协助团队成员间的并行开发、特性分支纪录、代码上线和快速bugfix，提供了supporting branches。所不同的是，这些分支并不是一直存在的，只要完成使命，就会被删掉。</p>
<ul>
<li>feature branches</li>
<li>release branches</li>
<li>hotfix branches</li>
</ul>
<p>这些分支都有其特殊的用途。</p>
<h4 id="feature_branches">feature branches</h4><p>May branch off from：develop</p>
<p>Must merge back into：develop</p>
<p>Branch naming convention:anything except master, develop, release-, or hotfix-</p>
<p>feature branches 是用来开发新功能的分支。当开发一个新功能时，开发者不确定什么时候能够上线。feature branches可以一直存在，直到代码提交被合并到develop或者丢弃。feature braches通常情况下只存在于开发者的本地代码库中，而不在远程库中。</p>
<p>feature branch的创建</p>
<pre><code>git checkout －<span class="tag">b</span> myfeature develop
</code></pre><p>在myfeature分支开发完成后，合并到develop分支，然后推送到远程库origin／develop中</p>
<pre><code>git checkout develop <span class="comment">//切换本地分支</span>
git <span class="keyword">merge</span> --<span class="keyword">no</span>-ff myfeature <span class="comment">//在本地进行合并操作</span>
git branch -<span class="keyword">d</span> myfeature <span class="comment">//删除myfeature分支</span>
git push origin develop <span class="comment">//推送到origin/develop</span>
</code></pre><p>–no-ff 是取消fast forward的意思，强制在合并的时候生成一个新的commit，即使在能够fast forword的情况下。这样能够防止丢失feature branch的信息，因为后面会删除这个feature branch，如果使用了fast forward，那么feature branch的信息就没了。</p>
<h4 id="release_branches">release branches</h4><p>May branch off from:develop</p>
<p>Must merge back into:develop &amp; master</p>
<p>Branch naming convention: release-*</p>
<p>release branch是为了协助代码上线的分支，可以在此分支上做测试、修复bug、该metadata信息等。</p>
<p>创建release branch</p>
<pre><code>git checkout -<span class="tag">b</span> release-<span class="number">1.2</span> develop
./bump-version<span class="class">.sh</span> <span class="number">1.2</span>
git commit -<span class="tag">a</span> -m <span class="string">"Bumped version number to 1.2"</span>
</code></pre><p>在这里可以做一些bug修复等小工作，不适合做包含大量代码修改的工作。当代码修改完毕并通过测试的时候，这时的代码已经可以上线了，先把代码合并到master分支，然后合并到develop分支</p>
<pre><code>git checkout <span class="keyword">master</span>
<span class="title">git</span> merge --no-ff release-<span class="number">1.2</span>
git <span class="keyword">tag</span> <span class="title">-a</span> <span class="number">1.2</span>
git checkout develop
git merge --no-ff release-<span class="number">1.2</span>
git branch -d release-<span class="number">1.2</span>
</code></pre><h4 id="hotfix_branches">hotfix branches</h4><p>May branch off from:master</p>
<p>Must merge back into:develop&amp;master</p>
<p>Branch naming convention:hotfix-* </p>
<p>我的理解是hotfix branch的作用是可以进行紧急bug修复。创建一个hotfix branch</p>
<pre><code>git checkout -<span class="tag">b</span> hotfix-<span class="number">1.2</span>.<span class="number">1</span> master
./bump-version<span class="class">.sh</span> <span class="number">1.2</span>.<span class="number">1</span>
git commit -<span class="tag">a</span> -m <span class="string">"Bumped version number to 1.2.1"</span>
</code></pre><p>像release branch一样，修复完bug之后，把commit合并到master和develop</p>
<pre><code>git checkout master
git merge --no-ff hotfix-<span class="number">1.2</span><span class="number">.1</span>
git tag -a <span class="number">1.2</span><span class="number">.1</span>
git checkout develop
git merge --no-ff hotfix-<span class="number">1.2</span><span class="number">.1</span>
git branch -d hotfix-<span class="number">1.2</span><span class="number">.1</span>
</code></pre><p>需要注意的是，如果此时有release branch，应该合并commit到release branch而不是develop branch</p>
<p>大体上这篇文章的内容就是这样。当我写到这里的时候，我发现我们组的实际情况其实是与这些有些冲突的，因此到底该怎么做，还是要做一番思考的。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/09/20160709-java-dynamic-proxy/" itemprop="url">
                  20160709-java-dynamic-proxy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-09T13:24:53+08:00" content="2016-07-09">
              2016-07-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="java动态代理">java动态代理</h2><p>最近在看Spring AOP的实现方式，java动态代理是其基础，因此先研究了一下java动态代理。<br>java中的代理有下面两种</p>
<ul>
<li>静态代理：由程序员自己写代码实现的代理，编译成class文件并运行</li>
<li>动态代理：在程序运行的时候，运用反射机制动态创建的字节码并加载到内存中。</li>
</ul>
<p>静态代理基本上很熟悉了，本文主要讨论动态代理的适用和原理。动态代理所使用到的几部分内容：</p>
<ul>
<li>抽象接口，真实对象实现所用的接口，同时作为Proxy.newProxyInstance的一个参数</li>
<li>真实对象，真正执行逻辑运算的对象，由代理对象调用真实对象</li>
<li>代理对象，代替真实对象接受访问请求，调用真实对象</li>
</ul>
<p>使用代理的好处是能够对一次函数调用做自己的订制，加一些必要的内容，比如打log等。<br>java动态代理主要使用的几个类在java.lang.reflect包中，包括Prxoy和InvocationHandler这两个类。下面是一个非常简单的java动态代理的例子。</p>
<p>首先是声明一个接口</p>
<pre><code><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Service</span> {
    <span class="function"><span class="keyword">public</span> Object <span class="title">doService</span>(<span class="params"></span>)</span>;
}
</code></pre><p>然后声明一个类实现这个接口</p>
<pre><code><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealService</span> <span class="keyword">implements</span> <span class="title">Service</span></span>{
<span class="keyword">private</span> String serviceName;
<span class="function"><span class="keyword">public</span> <span class="title">RealService</span><span class="params">(String serviceName)</span></span>{
    <span class="keyword">this</span>.serviceName=serviceName;
}

<span class="function"><span class="keyword">public</span> Object <span class="title">doService</span><span class="params">()</span> </span>{
    System.out.println(<span class="string">"Service provided by "</span>+serviceName);
    <span class="keyword">return</span> <span class="keyword">null</span>;
}
}
</code></pre><p>声明一个类实现InvocationHandler</p>
<pre><code>public class <span class="type">ServiceDynamicProxy</span> implements <span class="type">InvocationHandler</span>{
private <span class="type">Object</span> obj;
public <span class="type">ServiceDynamicProxy</span>(<span class="type">Object</span> obj){
    this.obj=obj;
}
public <span class="type">Object</span> invoke(<span class="type">Object</span> proxy, <span class="type">Method</span> <span class="keyword">method</span>, <span class="type">Object</span>[] args)
        throws <span class="type">Throwable</span> {
    doPre();
    <span class="keyword">method</span>.invoke(obj, args);
    doPost();
    <span class="keyword">return</span> null;
}

public <span class="type">void</span> doPre(){
    <span class="type">System</span>.<span class="keyword">out</span>.println(<span class="string">"dynamic proxy do pre"</span>);
}

public <span class="type">void</span> doPost(){
    <span class="type">System</span>.<span class="keyword">out</span>.println(<span class="string">"dynamic proxy do post"</span>);
}
}
</code></pre><p>最后，写一段代码调用以上的代码即可</p>
<pre><code><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Client</span> {
<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>)</span>{
    RealService ser=<span class="keyword">new</span> RealService(<span class="string">"solid"</span>);
    InvocationHandler ih=<span class="keyword">new</span> ServiceDynamicProxy(ser);
    Class cls=ser.getClass();
    Service service = (Service) Proxy.newProxyInstance(cls.getClassLoader(), cls.getInterfaces(), ih);
    service.doService();
}
}
</code></pre><p>通过查看Proxy的代码可以看到，Proxy使用ProxyGenerator来动态生成了一个类的字节码加载。</p>
<pre><code>byte<span class="string">[]</span> proxyClassFile = ProxyGenerator.generateProxyClass(
        proxyName, interfaces);
</code></pre><p>反编译这个生成的class字节码(这部分从网上其<a href="http://www.cnblogs.com/flyoung2008/archive/2013/08/11/3251148.html" target="_blank" rel="external">他人的博客</a>中看到，我没有实际去反编译)</p>
<pre><code><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxySubject</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Service</span> {</span>
<span class="keyword">private</span> static <span class="function"><span class="keyword">Method</span> <span class="title">m1</span>;</span>
<span class="keyword">private</span> static <span class="function"><span class="keyword">Method</span> <span class="title">m0</span>;</span>
<span class="keyword">private</span> static <span class="function"><span class="keyword">Method</span> <span class="title">m3</span>;</span>
<span class="keyword">private</span> static <span class="function"><span class="keyword">Method</span> <span class="title">m2</span>;</span>

<span class="keyword">public</span> ProxySubject(InvocationHandler invocationhandler) {
    <span class="variable">super</span>(invocationhandler);
}

<span class="keyword">public</span> <span class="keyword">final</span> boolean equals(Object obj) {
    <span class="keyword">try</span> {
        <span class="keyword">return</span> ((Boolean) <span class="variable">super</span>.h.invoke(this, m1, <span class="keyword">new</span> Object[] { obj }))
                .booleanValue();
    } <span class="keyword">catch</span> (<span class="built_in">Error</span> _ex) {
    } <span class="keyword">catch</span> (Throwable throwable) {
        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(throwable);
    }
}

<span class="keyword">public</span> <span class="keyword">final</span> int hashCode() {
    <span class="keyword">try</span> {
        <span class="keyword">return</span> ((Integer) <span class="variable">super</span>.h.invoke(this, m0, <span class="literal">null</span>)).intValue();
    } <span class="keyword">catch</span> (<span class="built_in">Error</span> _ex) {
    } <span class="keyword">catch</span> (Throwable throwable) {
        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(throwable);
    }
}

<span class="keyword">public</span> <span class="keyword">final</span> void doService() {
    <span class="keyword">try</span> {
        <span class="variable">super</span>.h.invoke(this, m3, <span class="literal">null</span>);
        <span class="keyword">return</span>;
    } <span class="keyword">catch</span> (<span class="built_in">Error</span> _ex) {
    } <span class="keyword">catch</span> (Throwable throwable) {
        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(throwable);
    }
}

<span class="keyword">public</span> <span class="keyword">final</span> String toString() {
    <span class="keyword">try</span> {
        <span class="keyword">return</span> (String) <span class="variable">super</span>.h.invoke(this, m2, <span class="literal">null</span>);
    } <span class="keyword">catch</span> (<span class="built_in">Error</span> _ex) {
    } <span class="keyword">catch</span> (Throwable throwable) {
        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(throwable);
    }
}

static {
    <span class="keyword">try</span> {
        m1 = <span class="class"><span class="keyword">Class</span>.<span class="title">forName</span>("<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span>").<span class="title">getMethod</span>("<span class="title">equals</span>",</span>
                <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[] { <span class="title">Class</span>.<span class="title">forName</span>("<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span>") });</span>
        m0 = <span class="class"><span class="keyword">Class</span>.<span class="title">forName</span>("<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span>").<span class="title">getMethod</span>("<span class="title">hashCode</span>",</span>
                <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[0]);</span>
        m3 = <span class="class"><span class="keyword">Class</span>.<span class="title">forName</span>("<span class="title">Subject</span>")</span>
                .getMethod(<span class="string">"doService"</span>, <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[0]);</span>
        m2 = <span class="class"><span class="keyword">Class</span>.<span class="title">forName</span>("<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Object</span>").<span class="title">getMethod</span>("<span class="title">toString</span>",</span>
                <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[0]);</span>
    } <span class="keyword">catch</span> (NoSuchMethodException nosuchmethodexception) {
        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(nosuchmethodexception.getMessage());
    } <span class="keyword">catch</span> (ClassNotFoundException classnotfoundexception) {
        <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(classnotfoundexception.getMessage());
    }
}
}
</code></pre><p>从代码可以看到，这个动态生成的类是继承了Proxy类并实现了Service接口，先获取到了equals<br>、hashCode、doservice和toString这四个函数对应的method对象，当调用相关方法时，使用反射机制调用各个方法。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/02/20160702-threadlocal/" itemprop="url">
                  threadlocal
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-07-02T13:58:26+08:00" content="2016-07-02">
              2016-07-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="ThreadLocal">ThreadLocal</h2><p>为了解决多线程并发访问的问题，比较流行的做法是通过加锁等技术实现多线程访问的同步。而ThreadLocal从另一个角度给出了一种解决方案，就是多个线程不再访问公共的数据，而是每一个线程都有自己独一份的数据，因此再怎么修改也不会影响到其他线程。</p>
<p>这种方法在有些情况下比较适用，比如数据库连接池用ThreadLocal来保存当前线程所使用的Connection，以保证事物的有效性。</p>
<p>那么ThreadLocal是如何实现的呢？通过查看源码可以看到，在Thread的类生命中有如下一个threadlocalmap</p>
<pre><code>ThreadLocal.ThreadLocalMap threadLocals = <span class="literal">null</span>;
</code></pre><p>这个ThreadLocalMap是ThreadLocal的内部类，它的实现方式有点类似于HashMap。内部存储是由下面这个数组负责实现的</p>
<pre><code><span class="keyword">private</span> <span class="built_in">Entry</span>[] table;
</code></pre><p>Entry是ThreadLocalMap的一个内部类，就是ThreadLocalMap中数组元素的类型</p>
<pre><code>static <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">WeakReference&lt;ThreadLocal&gt;</span> {</span>
    <span class="type">Object</span> value;
    <span class="type">Entry</span>(<span class="type">ThreadLocal</span> k, <span class="type">Object</span> v) {
        <span class="keyword">super</span>(k);
        value = v;
    }
}
</code></pre><p>如此可以看到，这个Entry继承了WeakReference类，弱引用引用的是ThreadLocal，同时，这个ThreadLocal对象也用来当做一个Key区分Object。这个地方使用了弱引用，关于java中的弱引用以后再专门写点东西研究一下。</p>
<p>到这里，可能已经有点晕了，其实看一下ThreadLocal的get和set实现基本就能理解这个地方到底是如何实现的了。</p>
<pre><code><span class="keyword">public</span> T get() {
    <span class="keyword">Thread</span> t = <span class="keyword">Thread</span><span class="built_in">.</span>currentThread();
    ThreadLocalMap <span class="built_in">map</span> = getMap(t);
    <span class="keyword">if</span> (<span class="built_in">map</span> != <span class="built_in">null</span>) {
        ThreadLocalMap<span class="built_in">.</span>Entry e = <span class="built_in">map</span><span class="built_in">.</span>getEntry(this);
        <span class="keyword">if</span> (e != <span class="built_in">null</span>)
            <span class="keyword">return</span> (T)e<span class="built_in">.</span>value;
    }
    <span class="keyword">return</span> setInitialValue();
}
<span class="keyword">public</span> <span class="literal">void</span> <span class="built_in">set</span>(T value) {
    <span class="keyword">Thread</span> t = <span class="keyword">Thread</span><span class="built_in">.</span>currentThread();
    ThreadLocalMap <span class="built_in">map</span> = getMap(t);
    <span class="keyword">if</span> (<span class="built_in">map</span> != <span class="built_in">null</span>)
        <span class="built_in">map</span><span class="built_in">.</span><span class="built_in">set</span>(this, value);
    <span class="keyword">else</span>
        createMap(t, value);
}
</code></pre><p>这个ThreadLocal操作Thread线程自己的ThreadLocalMap来get和set数据，同时ThreadLocal把自己当作Key。</p>
<p>这个ThreadLocal其实是用空间来换时间的一种思路，使用它会使得内存占用更多的空间。不应该用ThreadLocal存储很大的数据，否则在线程很多的情况下，会大量占用内存，导致jvm gc频繁发生，使得系统的响应变慢很多。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/10/20160310-micro-service/" itemprop="url">
                  micro service
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-10T22:59:48+08:00" content="2016-03-10">
              2016-03-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/architecture/" itemprop="url" rel="index">
                    <span itemprop="name">architecture</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Monolithic_architecture">Monolithic architecture</h2><p>传统的web项目架构是这样的，所有的后台逻辑放在一个项目中，这些逻辑可能是分层的，比如有表示层、逻辑层、数据层等，这些一起组成了一个项目。这种项目架构称为monolithic。例如，一个java项目被打包成一个war包，然后放到web server上去执行。如下图</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-10%20%E4%B8%8B%E5%8D%8811.43.11.png" alt="monolithic"></p>
<p>这种架构的好处在于，易于开发，易于部署，易于水平扩展。<br>缺点却是很明显</p>
<ul>
<li>不利于项目组中的新人上手</li>
<li>不利于做持续部署（不知道continuous deployment怎么翻译），为了修改一个模块而必须重新发布部署整个项目。</li>
<li>数据库无法扩容，并且每个server实例都会访问所有的数据，使得数据库的缓存失效</li>
<li>团队开发合并代码出现冲突概率更大</li>
<li>…</li>
</ul>
<h2 id="Microservices_architechture">Microservices architechture</h2><p>为了解决monolithic架构的问题，最近几年业界提出了micro service的架构，而且这种架构在实际运用中使用的越来越广泛。<br>这种架构引入了<a href="http://microservices.io/articles/scalecube.html" target="_blank" rel="external">scale cube</a>的思想,把一整个项目按照功能区分为很多个不同的service，每个service提供一个核心的功能歌，并且只做这一件事情。比如说，电商系统架构包含支付服务、物品信息服务、用户管理服务、订单服务等。<br>服务之间的通信使用同步协议如http／rest／thrift，或者异步协议。<br>服务的部署是相互分割开来的。每个service有自己的数据库</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-11%20%E4%B8%8A%E5%8D%8812.14.31.png" alt="microservice"></p>
<p>这种架构的缺点</p>
<ul>
<li>难测试</li>
<li>需要处理服务之间的信息交互问题</li>
<li>这种架构提升了部署和管理系统的复杂度<br>这种架构的优点</li>
<li>每个服务专注于一个目的，小而精</li>
<li>服务单独部署</li>
<li>能有效的隔离系统错误，某个服务出现问题，并不会影响其他的服务</li>
</ul>
<p>我的疑问？如果每个服务有自己的数据库，那么如果在需要联合查询的场景下，微服务架构怎么解决这个问题？<a href="http://www.slideshare.net/chris.e.richardson/developing-eventdriven-microservices-with-event-sourcing-and-cqrs-svcc-svcc2015" target="_blank" rel="external">http://www.slideshare.net/chris.e.richardson/developing-eventdriven-microservices-with-event-sourcing-and-cqrs-svcc-svcc2015</a></p>
<h2 id="API_Gateway">API Gateway</h2><p>如果用微服务的架构开发一个电商网站，产品详情页可能需要用到的服务有产品信息服务、价格服务、订单服务、库存服务等。那么一些问题也随之而来</p>
<ul>
<li>因为微服务架构下，没个服务都是专注的，那么整个系统中会有很多服务</li>
<li>不同的客户端需要不同的数据</li>
<li>服务的实例的数量和地址会动态变化的</li>
<li>服务划分的过程应该是对客户端透明的。</li>
</ul>
<p>在这些服务前面加上一层，就能有效解决上面这些问题，这就是api gateway</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-12%20%E4%B8%8B%E5%8D%885.52.30.png" alt="api gateway"></p>
<p>加入API Gateway的好处是</p>
<ul>
<li>把服务的划分跟客户端分隔开</li>
<li>客户端不需要知道也不关心这些服务的位置</li>
<li>为不同类型的客户端选择最合适的服务</li>
<li>把调用服务的逻辑放在 api gateway层，简化了客户端</li>
</ul>
<p>这种方法有两个缺点</p>
<ul>
<li>api gateway需要开发和维护</li>
<li>增加了一次客户端调用返回的总时间</li>
</ul>
<h2 id="Client-side_service_discovery">Client-side service discovery</h2><p>服务之间也会相互调用。在monolithic架构下，服务调用是通过语言层上的函数调用实现的。在传统架构下，我们知道服务的固定的地址，因此可以轻易的调用它。<br>然而，在微服务架构下，服务的地址和实例数量都会变得，而且服务很可能跑在虚拟容器中，它的ip也是会变得。因此，我们需要解决的问题就是让服务的客户端能够向动态变化的服务实力集合发起访问。API Gateway，作为服务的客户端，该如何发现服务实例。解决方案如下图</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-12%20%E4%B8%8B%E5%8D%886.16.43.png" alt="clientside discovery"></p>
<h2 id="Server-side_service_discovery">Server-side service discovery</h2><p>对于前面提出的服务发现问题，还有一种Server side discovery的方法。客户端在要访问某个服务时，客户端先访问一个router（部署在固定的网络地址），这个router向service registry发起查询，然后向服务的某个实例发起访问。</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-12%20%E4%B8%8B%E5%8D%886.28.40.png" alt="serverside discovery"></p>
<p>与client－side service discovery相比，server side discovery的客户端代码更简单，然而却增加了更多的网络访问步骤。</p>
<h2 id="Service_registry">Service registry</h2><p>前两节提到的，关于服务注册。相当于一个存储服务信息的数据库，存储了实例信息和地址等信息。当服务实例启动的时候，在注册服务注册自己，实例停止的时候，告知注册服务。eureka、zookeeper等是现有的service registry。<br>服务的客户端可以通过service registry 发现服务。然而，这也给整个架构带来风险，一旦service registry down掉，整个架构都不可用。</p>
<h2 id="Self_registration">Self registration</h2><p>如何实现service registry，服务必须在启动和关闭的时候注册，并且当服务crash 的时候也需要unregistry。因此，服务必须周期性的更新自得信息，重新注册。<br>使用zookeeper作service registry。没个服务对应zookeeper中的一个znode。在服务的一个实例启动的时候，在zookeeper该服务的znode节点下新家一个临时性的znode节点，标示一个实例。该节点包含了服务实例的地址信息。客户端取到该服务下的所有节点来决定调用哪个实例。如果实例非法推出，没有从zookeeper删除节点，则zookeeper会在过期时间到的时候删除节点</p>
<h2 id="3rd_Party_Registry">3rd Party Registry</h2><p>加入第三方注册器来负责服务的注册。<br>这种方式可以简化服务代码，服务并不需要考虑注册的问题。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/06/20160306-message-queue-system-of-xiecheng/" itemprop="url">
                  携程消息系统学习笔记1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-03-06T22:06:12+08:00" content="2016-03-06">
              2016-03-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/distributed-system/" itemprop="url" rel="index">
                    <span itemprop="name">distributed system</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>message queue具有广泛的使用场景，在国内的各大厂商内部也多有应用。例如，使用消息队列做索引实时更新和支付等。</p>
<h2 id="MQ的特点">MQ的特点</h2><ul>
<li>降低系统耦合程度，使得系统业务可以做异步处理，同时有利于抵御流量波峰。</li>
<li>使得系统易于扩展，系统的生产者和消费者可以通过消息队列协作，灵活添加。</li>
</ul>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-03-06%20%E4%B8%8B%E5%8D%8810.15.19.png" alt="系统架构图"></p>
<p>如上图是主要的架构图。支持两种持久化方式，kafka和mysql，因为两者各有优缺点。kafka性能好，然而不支持复杂的操作，不好做监控。mysql性能不如kafka，然而却能让开发者做任何想做的事，易于做监控。</p>
<h2 id="单机优化">单机优化</h2><p>主要从存入消息和读取消息两个方面做单机优化</p>
<h3 id="存入消息">存入消息</h3><ul>
<li>只有，insert,没有update or delete</li>
<li>利用mysql的partition机制，分表，这样，对于过时的数据可以及时清理，这么做弥补了没有delete</li>
<li>只根据id做索引，索引是一个很重的操作，很费时间，这里把时间减少到最小。</li>
<li>批量写入，在broker受到写入消息后，不是马上写入，做个暂存，达到批量写入上限的时候一起写入。此处就要在性能和数据延迟之间做出取舍。</li>
</ul>
<p>对于重发操作，也有一些优化。在系统中有一个重发表，于消息表几乎一样，多了一个纪录重发时间的字段。问题是，如果加上这个重发时间，并且让用户自己设置任意的重发时间的话，会导致数据不是按重发时间书序排列的。如此，在做数据重发的时候，会遇到困难，可能每次都要做一些便利操作，费时，或者需要对id和重发时间两个属性做索引，也会大大增大索引时间。因此，此处不让用户随意去设置重发时间，而是设置一个固定的值，如此，数据会按顺序排列。</p>
<h3 id="取出消息">取出消息</h3><ul>
<li>broker捕获并纪录写入事件，不需要轮训db</li>
<li>消息buffer，相当于做了一层缓存</li>
<li>消费者既不用push也不用poll，而是使用long polling。当消费者想要数据的时候，向broker发送信息，broker直到有新的消息到来的时候立即返回新的消息，消费者的监听器受到消息。</li>
</ul>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/28/20160228-pyqt-install-and-homebrew-use/" itemprop="url">
                  pyqt安装和homebrew使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-02-28T14:39:31+08:00" content="2016-02-28">
              2016-02-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>最近想要自己写两个桌面应用，因为涉及到机密信息，放到网上总归是不保险的，不论各种软件把自己吹的多安全，可是还是不能完全放心。在这种情况下，作为一个攻城狮程序猿，不如自己开发一个软件，对于自己的机密信息自己写加密算法加密，保证没有人能够解开。然而问题来了，我对苹果那一套开发语言和技术框架，并且现在也不想去过多的学习这方面的内容。因此就想用pyqt吧，因为python写个软件应该是很顺手的。人生苦短，我用python嘛。然后就装pyqt，使用homebrew安装非常的简单，如果想要源代码安装，也不难，但我还是不想浪费时间。</p>
<pre><code><span class="keyword">brew </span>install pyqt
</code></pre><p>homebrew会把pyqt依赖的东西一并下载安装，qt和sip。安装完成，发现报错。</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-02-28%20%E4%B8%8B%E5%8D%882.11.30.png" alt="homebrew error"></p>
<p>如上图，执行link qt的时候出错，对于homebrew使用并不熟练的我就去google了一下，在<a href="http://stackoverflow.com/questions/27784545/brew-error-could-not-symlink-path-is-not-writable" target="_blank" rel="external">stack overflow</a>上发现了解决方法。使用</p>
<pre><code><span class="keyword">brew </span>doctor
</code></pre><p>命令，可以看到homebrew给出的解决方法，按照提示，就可以修正error了。</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-02-28%20%E4%B8%8B%E5%8D%882.36.19.png" alt="error correct"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/05/20151205Timer/" itemprop="url">
                  Timer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-12-05T13:15:37+08:00" content="2015-12-05">
              2015-12-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="Timer_java">Timer java</h2><p>最近在线上环境中使用Timer碰到了一些问题。在线上环境中有一个跑定时任务的机器，但是我最近发现它跑起来有些诡异，时间差的很多，差半天的时候都有可能。于是，看一下这里面的源码实现。</p>
<p>在打开源码，看class 描述的时候，基本就明白了是为什么。</p>
<blockquote>
<p>Corresponding to each Timer object is a single background thread that is used to execute all of the timer’s tasks,sequentially.Timer tasks should complete quickly. If a timer task takes excessive time to complete, it hogs the timer’s task execution thread. This can, in turn , delay the execution of subsequent tasks,which may bunch up and execute in rapid succesion when the offending task finally completes.</p>
</blockquote>
<p>每一个Timer对象都有一个线程在运行，线程顺序的执行任务。如果一个task执行超时，会导致后面的任务延迟执行。</p>
<p>Timer中字段</p>
<pre><code><span class="keyword">private</span> TaskQueue <span class="built_in">queue</span>=<span class="keyword">new</span> TaskQueue();
<span class="keyword">private</span> TimerThread thread=<span class="keyword">new</span> TimerThread();
<span class="keyword">private</span> Object threadReaper=<span class="keyword">new</span> Object(){
    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> throws Throwable</span>{
        synchronized(<span class="built_in">queue</span>){
            thread.newTaskMayBeShceduled=<span class="literal">false</span>;
            <span class="built_in">queue</span>.notify();
        }
    }
};
<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> nextSerialNumber=<span class="number">0</span>;
<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> synchronized <span class="keyword">int</span> <span class="title">serialNumber</span><span class="params">()</span></span>{
    <span class="keyword">return</span> nextSerialNumber++;
}
</code></pre><p>queue是Timer中的任务队列，由thread顺序执行。queue里面用最小堆实现，里面的一些算法都是数据结构与算法里的基础，不多介绍。thread就是前面说到的Timer对应的线程，他是TimerThread类型的。</p>
<pre><code><span class="keyword">class</span> TimerThread extends Thread{
    <span class="comment">//This flag is set to false by the reaper to inform us that there are //no more live references to our Timer object.</span>
    boolean newTaskMayBeScheduled = <span class="literal">true</span>;
    <span class="keyword">private</span> TaskQueue <span class="built_in">queue</span>;
    TimerThread(TaskQueue <span class="built_in">queue</span>){
        <span class="keyword">this</span>.<span class="built_in">queue</span>=<span class="built_in">queue</span>;
    }
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>{
        <span class="keyword">try</span>{
            mainLoop();
            }finally{
                synchronized(<span class="built_in">queue</span>){
                    newTaskMayBeScheduled=<span class="literal">false</span>;
                    <span class="built_in">queue</span>.clear();
                }
        }
    }
    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span></span>{
        <span class="keyword">while</span>(<span class="literal">true</span>){
            <span class="keyword">try</span>{
                TimerTask task;
                boolean taskFired;
                synchronized(<span class="built_in">queue</span>){
                    <span class="keyword">while</span>(<span class="built_in">queue</span>.isEmpty()&amp;&amp;newTaskMayBeScheduled){
                        <span class="built_in">queue</span>.wait();
                    }
                    <span class="keyword">if</span>(<span class="built_in">queue</span>.isEmpty())
                        <span class="keyword">break</span>;
                    <span class="keyword">long</span> currentTime,executionTime;
                    task=<span class="built_in">queue</span>.getMin();
                    synchronized(task.lock){
                        <span class="keyword">if</span>(task.state==TimerTask.CANCELLED){
                            <span class="built_in">queue</span>.removeMin();
                            <span class="keyword">continue</span>;
                        }
                        currentTime=System.currentTimeMills();
                        executionTime=task.nextExecutionTime();
                        <span class="keyword">if</span>(taskFired=(executionTime&lt;=currentTime)){
                            <span class="keyword">if</span>(task.period==<span class="number">0</span>){
                                <span class="built_in">queue</span>.removeMin();
                                task.state=TimerTask.EXECUTED;
                            }<span class="keyword">else</span>{
                                <span class="built_in">queue</span>.rescheduleMin(task.period&lt;<span class="number">0</span>?currentTIme-task.period:executionTime+task.period);
                            }
                        }
                    }
                    <span class="keyword">if</span>(!taskFired){
                        <span class="built_in">queue</span>.wait(executionTime-currentTime);
                    }
                }
                <span class="keyword">if</span>(taskFired)
                    task.run();
            }<span class="keyword">catch</span>(InterruptedException e){
            }
        }
    }
}
</code></pre><p>Timer中有两个函数，schedule和scheduleAtFixedRate。他们的区别用语言描述不好描述也不直观，直接看源码。在上面TimerThread的mainLoop种，在取出执行时间最小的任务之后，在执行之前先计算这个任务下一次执行的时间，然后再把它重新扔进队列中。在此处计算下一次执行时间的时候，这两个方法加入的任务的计算方式是不一样的。</p>
<ul>
<li>由schedule添加的task，其下一次执行的计算时间是currentTime+period</li>
<li>由scheduleAtFixedRate添加的task，其下一次执行的计算时间是executionTime+period</li>
</ul>
<p>我的代码中使用的是scheduleAtFixedRate函数，然而还是出现了delay的情况，说明时前面有的task执行的非常慢，导致后面的task全部delay了。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/28/20151128vi/" itemprop="url">
                  vi
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-28T00:01:46+08:00" content="2015-11-28">
              2015-11-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h2 id="vi">vi</h2><p>vi共有三种模式</p>
<ul>
<li>一般模式，用vi打开文件时就处于一般模式下，可以移动光标，做删除复制粘贴等操作</li>
<li>编辑模式，实际编辑文本</li>
<li>命令模式，输入命令做一些操作，例如查找、存储、推出等功能。</li>
</ul>
<p>这三种模式的转换如下图</p>
<p><img src="http://7xojgs.com1.z0.glb.clouddn.com/vi_mode.001.png" alt="模式转换图"></p>
<h3 id="一般模式下的操作">一般模式下的操作</h3><table>
<thead>
<tr>
<th>指令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>h</td>
<td>左移</td>
</tr>
<tr>
<td>j</td>
<td>下移</td>
</tr>
<tr>
<td>k</td>
<td>上移</td>
</tr>
<tr>
<td>l</td>
<td>右移</td>
</tr>
<tr>
<td>n [space]</td>
<td>n表示数字，按下空格，光标移动到这一行的第n个字符</td>
</tr>
<tr>
<td>0或［HOME］</td>
<td>移动到一行的最前面</td>
</tr>
<tr>
<td>$或［END］</td>
<td>移动到一行的最后面</td>
</tr>
<tr>
<td>H</td>
<td>光标移动到屏幕最上面一行的第一个字符</td>
</tr>
<tr>
<td>M</td>
<td>光标移动到屏幕最中间一行的第一个字符</td>
</tr>
<tr>
<td>L</td>
<td>光标移动到屏幕最下面一行的第一个字符</td>
</tr>
<tr>
<td>G</td>
<td>光标移动到这个档案的最后一行</td>
</tr>
<tr>
<td>nG</td>
<td>光标移动到这个档案的第n行</td>
</tr>
<tr>
<td>gg</td>
<td>光标移动到这个档案的第一行</td>
</tr>
<tr>
<td>n [enter]</td>
<td>光标向下移动n行</td>
</tr>
<tr>
<td>/word</td>
<td>向光标之下搜寻一个名称为word的字符串</td>
</tr>
<tr>
<td>？word</td>
<td>向光标之上搜寻一个名称为word的字符串</td>
</tr>
<tr>
<td>n</td>
<td>重复前一个搜寻的动作</td>
</tr>
<tr>
<td>N</td>
<td>反向进行前一个搜寻动作</td>
</tr>
<tr>
<td>:n1,n2s/word1/word2/g</td>
<td>在n1和n2行之间搜寻word1字符串，并把它替换为word2</td>
</tr>
<tr>
<td>x</td>
<td>在一行当中，向后删除一个字符</td>
</tr>
<tr>
<td>X</td>
<td>在一行当中，向前删除一个字符</td>
</tr>
<tr>
<td>nx</td>
<td>向后删除n个字符</td>
</tr>
<tr>
<td>dd</td>
<td>删除一整行</td>
</tr>
<tr>
<td>ndd</td>
<td>向下删除n行</td>
</tr>
<tr>
<td>yy</td>
<td>复制光标所在的那一行</td>
</tr>
<tr>
<td>nyy</td>
<td>复制光标所在的向下的n行</td>
</tr>
<tr>
<td>p</td>
<td>粘贴</td>
</tr>
<tr>
<td>u</td>
<td>复原前一个动作</td>
</tr>
<tr>
<td>[Ctrl]+r</td>
<td>重做上一个动作</td>
</tr>
</tbody>
</table>
<h3 id="一般模式切换到编辑模式">一般模式切换到编辑模式</h3><table>
<thead>
<tr>
<th>指令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>i,I</td>
<td>i为从光标所在的位置处插入，I为从光标所在行的第一个非空格处插入</td>
</tr>
<tr>
<td>a,A</td>
<td>a为从光标所在的下一个字符开始插入，A为葱光标所在行的最后一个字符处开始插入</td>
</tr>
<tr>
<td>o,O</td>
<td>o为从光标所在的下一行处插入新的一行，O为从光标所在处的上一行插入新的一行</td>
</tr>
</tbody>
</table>
<h3 id="一般模式切换到指令模式">一般模式切换到指令模式</h3><table>
<thead>
<tr>
<th>指令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>:w,:w!</td>
<td>写入硬盘，强制写入硬盘</td>
</tr>
<tr>
<td>:q,:q!</td>
<td>推出，强制退出</td>
</tr>
<tr>
<td>:wq</td>
<td>写入磁盘并推出</td>
</tr>
<tr>
<td>ZZ</td>
<td>若文件没有更新，则不存储离开，若更新了，就存储后离开</td>
</tr>
<tr>
<td>:w [filename]</td>
<td>将编辑的数据存储成另一个档案</td>
</tr>
<tr>
<td>:r [filename]</td>
<td>读入另一个档案</td>
</tr>
<tr>
<td>:set nu</td>
<td>显示行号</td>
</tr>
</tbody>
</table>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/11/25/20151125Date-In-Java/" itemprop="url">
                  Date-In-Java
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2015-11-25T01:07:01+08:00" content="2015-11-25">
              2015-11-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h3 id="java_中的时间">java 中的时间</h3><p>最近接了一个任务，在快要上线的时候发现完全没有考虑到时区的问题（国际业务开发的任务），当我要改的时候，发现对于标准时间，北京时间等等的东西很陌生，觉得很混乱，因此晚上回到家就想要把他弄明白。</p>
<h4 id="基本概念">基本概念</h4><p>首先是基本概念</p>
<ul>
<li>时区：初中地理学过，北京处于东八区，因此使用的是东八区的时间。</li>
<li>CST:china standard time utc+8:00 中国标准时间</li>
<li>UTC:Universal Time Coordinated 世界协调时间，这是标准时间与时区无关的时间。在0时区</li>
<li>GMT:格林威治标准时间</li>
<li>Unix timestamp:unix时间戳，从格林威治时间1970年1月1日0时00分00秒起至现在的总秒数。</li>
<li>utc和gmt基本是一致的，gmt=utc,gmt+8=utc+8=cst</li>
</ul>
<h4 id="java中的时间">java中的时间</h4><p>现在我理解的Date表示的是一个时间点，据格林威治时间到现在的毫秒数，是与时区和locale都没有关系的一个概念。因此，在数据库里存储的时候一般是存储这个与时区没有关系的毫秒数。然后在需要显示时间的地方再根据时区设置转换成相应的时间格式。</p>
<pre><code><span class="built_in">Date</span> <span class="built_in">date</span>=<span class="literal">new</span> <span class="built_in">Date</span>();
SimpleDateFormat sdf7=<span class="literal">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);
sdf7<span class="built_in">.</span>setTimeZone(TimezZone<span class="built_in">.</span>getTimeZone(<span class="string">"GMT+7"</span>));
<span class="built_in">String</span> strDate=sdf7<span class="built_in">.</span>format(<span class="built_in">date</span>);
</code></pre><p>在java中有两种获取标准时间毫秒时的方法</p>
<ul>
<li>System.getCurrentTimeMills()</li>
<li>Date.getTime()</li>
</ul>
<pre><code><span class="built_in">Date</span> <span class="built_in">date</span>=<span class="literal">new</span> <span class="built_in">Date</span>();
</code></pre><p>表示的是当前时间点，与时区无关。</p>
<pre><code>SimpleDateFormat sdf=<span class="literal">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);
sdf7<span class="built_in">.</span>setTimeZone(TimezZone<span class="built_in">.</span>getTimeZone(<span class="string">"GMT+7"</span>));
<span class="built_in">String</span> strDate=sdf7<span class="built_in">.</span>format(<span class="built_in">date</span>);
</code></pre><p>当要转换成可读的时间表示时，必须与时间挂钩。SimpleDateFormat可以完成这个转换，如果没有设置时区就去本地系统默认的时区。</p>
<pre><code>Calendar calendar=Calendar.getInstance()<span class="comment">;</span>
Date d=calendar.getTime()<span class="comment">;</span>
</code></pre><p>Calendar是基于时区的，但从Calendar获得的Date时没有时区的。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/uploads/avatar.jpg" alt="wys" itemprop="image"/>
          <p class="site-author-name" itemprop="name">wys</p>
        </div>
        <p class="site-description motion-element" itemprop="description">I'm concerned with questions, not simply of immutable truth, but of practice and expedience.</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wys</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    
    

  


  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  

  
  

</body>
</html>
